build:
    box: google/golang
    steps:
      # Sets the go workspace and places you package
      # at the right place in the workspace tree
      - setup-go-workspace

      - script:
          name: setup env
          code: |
            export GOROOT=/usr/local/go
            export GOPATH=$(pwd)
            go env

      # Gets the dependencies
      - script:
          name: go get
          code: |
              go get github.com/vend/oauth2_proxy

      ## Test the project
      #- script:
      #    name: go test
      #    code: go test ./..

      # Statically build the project
      - script:
          name: go build
          code: CGO_ENABLED=0 go build -a -ldflags '-s' -installsuffix cgo -o app .

      # Copy binary to a location that gets passed along to the deploy pipeline
      - script:
          name: copy binary
          code: cp app "$WERCKER_OUTPUT_DIR"

deploy:
    box: google/golang
    steps:
      # Use the scratch step to build a container from scratch based on the files present
      - internal/docker-scratch-push:
          username: $QUAY_USERNAME
          password: $QUAY_PASSWORD
          entrypoint: ./app
          cmd: --help
          tag: $SCRATCH_TAG
          ports: "4180"
          repository: quay.io/vend/oauth2_proxy
          registry: https://quay.io
